<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flipper Zero Firmware: Flipper Zero OTA update process</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Flipper Zero Firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Flipper Zero OTA update process </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md164"></a>
Executing code from RAM</h1>
<p >In Flipper firmware, we have a special boot mode that loads a specially crafted system image into RAM and transfers control to it. System image executing in RAM has full write access to Flipper's entire flash memory — something that's not possible when running main code from the same flash.</p>
<p >We leverage that boot mode to perform OTA firmware updates, including operations on a radio stack running on the second MCU core.</p>
<h1><a class="anchor" id="autotoc_md165"></a>
How does Flipper OTA work?</h1>
<p >Installation of OTA updates goes through 3 stages:</p>
<h2><a class="anchor" id="autotoc_md166"></a>
1. Backing up internal storage (&lt;tt&gt;/int&lt;/tt&gt;)</h2>
<p >It is a special partition of Flipper's flash memory, taking up all available space not used by the firmware code. Newer versions of firmware may be of different size, and simply installing them would cause flash repartitioning and data loss.</p>
<p >So, before taking any action on the firmware, we back up the current configuration from <code>/int</code> into a plain tar archive on the SD card.</p>
<h2><a class="anchor" id="autotoc_md167"></a>
2. Performing device update</h2>
<p >The main firmware loads an updater image — a customized build of the main Flipper firmware — into RAM and runs it. <a class="el" href="struct_updater.html">Updater</a> performs operations on system flash as described by an Update manifest file.</p>
<p >First, if there's a Radio stack image bundled with the update, updater compares its version with the currently installed one. If they don't match, updater performs stack deinstallation followed by writing and installing a new one. The installation itself is performed by proprietary software FUS running on Core2, and leads to a series of system restarts.</p>
<p >Then, updater validates and corrects Option Bytes — a special memory region containing low-level configuration for Flipper's MCU.</p>
<p >After that, updater loads a <code>.dfu</code> file with firmware to be flashed, checks its integrity using CRC32, writes it to system flash and validates written data.</p>
<h2><a class="anchor" id="autotoc_md168"></a>
3. Restoring internal storage and updating resources</h2>
<p >After performing operations on flash memory, the system restarts into newly flashed firmware. Then it performs restoration of previously backed up <code>/int</code> contents.</p>
<p >If the update package contains an additional resources archive, it is extracted onto the SD card.</p>
<h1><a class="anchor" id="autotoc_md169"></a>
Update manifest</h1>
<p >An update package comes with a manifest that contains a description of its contents. The manifest is in Flipper <a class="el" href="struct_file.html" title="Structure that hold file index and returned api errors.">File</a> Format — a simple text file, comprised of key-value pairs.</p>
<h2><a class="anchor" id="autotoc_md170"></a>
Mandatory fields</h2>
<p >An update manifest must contain the following keys in the given order:</p>
<ul>
<li><b>Filetype</b>: a constant string, "Flipper firmware upgrade configuration".</li>
<li><b><a class="el" href="struct_version.html">Version</a></b>: manifest version. The current value is 2.</li>
<li><b>Info</b>: arbitrary string, describing package contents.</li>
<li><b>Target</b>: hardware revision for which the package is built.</li>
<li><b><a class="el" href="struct_loader.html">Loader</a></b>: file name of stage 2 loader that is executed from RAM.</li>
<li><b><a class="el" href="struct_loader.html">Loader</a> CRC</b>: CRC32 of loader file. Note that it is represented in little-endian hex.</li>
</ul>
<h2><a class="anchor" id="autotoc_md171"></a>
Optional fields</h2>
<p >Other fields may have empty values. In this case, updater skips all operations related to these values.</p>
<ul>
<li><b>Radio</b>: file name of radio stack image, provided by STM.</li>
<li><b>Radio address</b>: address to install the radio stack at. It is specified in Release Notes by STM.</li>
<li><b>Radio version</b>: radio major, minor and sub versions followed by branch, release and stack type packed into 6 hex-encoded bytes.</li>
<li><b>Radio CRC</b>: CRC32 of radio image.</li>
<li><b>Resources</b>: file name of TAR archive with resources to be extracted onto the SD card.</li>
<li><b>OB reference</b>, <b>OB mask</b>, <b>OB write mask</b>: reference values for validating and correcting option bytes.</li>
</ul>
<h1><a class="anchor" id="autotoc_md172"></a>
OTA update error codes</h1>
<p >We designed the OTA update process to be as fail-safe as possible. We don't start any risky operations before validating all related pieces of data to ensure we don't leave the device in a partially updated, or bricked, state.</p>
<p >Even if something goes wrong, updater allows you to retry failed operations and reports its state with an error code. These error codes have an <code>[XX-YY]</code> format, where <code>XX</code> encodes the failed operation, and <code>YY</code> contains extra details on its progress where the error occurred.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Stage description   </th><th class="markdownTableHeadRight">Code   </th><th class="markdownTableHeadNone">Progress   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><a class="el" href="struct_loading.html">Loading</a> update manifest   </td><td class="markdownTableBodyRight"><b>1</b>   </td><td class="markdownTableBodyNone"><b>13</b>   </td><td class="markdownTableBodyNone"><a class="el" href="struct_updater.html">Updater</a> reported hardware version mismatch    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>20</b>   </td><td class="markdownTableBodyNone">Failed to get saved manifest path    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>30</b>   </td><td class="markdownTableBodyNone">Failed to load manifest    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>40</b>   </td><td class="markdownTableBodyNone">Unsupported update package version    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>50</b>   </td><td class="markdownTableBodyNone">Package has mismatching HW target    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>60</b>   </td><td class="markdownTableBodyNone">Missing DFU file    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>80</b>   </td><td class="markdownTableBodyNone">Missing radio firmware file    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Backing up LFS   </td><td class="markdownTableBodyRight"><b>2</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">FS read/write error    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Checking radio FW   </td><td class="markdownTableBodyRight"><b>3</b>   </td><td class="markdownTableBodyNone"><b>0-99</b>   </td><td class="markdownTableBodyNone">Error reading radio firmware file    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>100</b>   </td><td class="markdownTableBodyNone">CRC mismatch    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Uninstalling radio FW   </td><td class="markdownTableBodyRight"><b>4</b>   </td><td class="markdownTableBodyNone"><b>0</b>   </td><td class="markdownTableBodyNone">SHCI Delete command error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>80</b>   </td><td class="markdownTableBodyNone">Error awaiting command status    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Writing radio FW   </td><td class="markdownTableBodyRight"><b>5</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">Block read/write error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Installing radio FW   </td><td class="markdownTableBodyRight"><b>6</b>   </td><td class="markdownTableBodyNone"><b>0</b>   </td><td class="markdownTableBodyNone">SHCI Install command error    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>80</b>   </td><td class="markdownTableBodyNone">Error awaiting command status    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Radio is updating   </td><td class="markdownTableBodyRight"><b>7</b>   </td><td class="markdownTableBodyNone"><b>10</b>   </td><td class="markdownTableBodyNone">Error waiting for operation completion    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Validating opt. bytes   </td><td class="markdownTableBodyRight"><b>8</b>   </td><td class="markdownTableBodyNone"><b>yy</b>   </td><td class="markdownTableBodyNone">Option byte code    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Checking DFU file   </td><td class="markdownTableBodyRight"><b>9</b>   </td><td class="markdownTableBodyNone"><b>0</b>   </td><td class="markdownTableBodyNone">Error opening DFU file    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>1-98</b>   </td><td class="markdownTableBodyNone">Error reading DFU file    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"></td><td class="markdownTableBodyRight"></td><td class="markdownTableBodyNone"><b>99-100</b>   </td><td class="markdownTableBodyNone">Corrupted DFU file    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Writing flash   </td><td class="markdownTableBodyRight"><b>10</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">Block read/write error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Validating flash   </td><td class="markdownTableBodyRight"><b>11</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">Block read/write error    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Restoring LFS   </td><td class="markdownTableBodyRight"><b>12</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">FS read/write error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Updating resources   </td><td class="markdownTableBodyRight"><b>13</b>   </td><td class="markdownTableBodyNone"><b>0-100</b>   </td><td class="markdownTableBodyNone">SD card read/write error   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md173"></a>
Building update packages</h1>
<h2><a class="anchor" id="autotoc_md174"></a>
Full package</h2>
<p >To build a full update package, including firmware, radio stack and resources for the SD card, run:</p>
<p ><code>./fbt COMPACT=1 DEBUG=0 updater_package</code></p>
<h2><a class="anchor" id="autotoc_md175"></a>
Minimal package</h2>
<p >To build a minimal update package, including only firmware, run:</p>
<p ><code>./fbt COMPACT=1 DEBUG=0 updater_minpackage</code></p>
<h2><a class="anchor" id="autotoc_md176"></a>
Customizing update bundles</h2>
<p >Default update packages are built with Bluetooth Light stack. You can pick a different stack if your firmware version supports it, and build a bundle with it by passing the stack type and binary name to <code>fbt</code>:</p>
<p ><code>./fbt updater_package COMPACT=1 DEBUG=0 COPRO_OB_DATA=scripts/ob_custradio.data COPRO_STACK_BIN=stm32wb5x_BLE_Stack_full_fw.bin COPRO_STACK_TYPE=ble_full</code></p>
<p >Note that <code>COPRO_OB_DATA</code> must point to a valid file in the <code>scripts</code> folder containing reference Option Byte data matching your radio stack type.</p>
<p >In certain cases, you might have to confirm your intentions by adding <code>COPRO_DISCLAIMER=...</code> to the build command line.</p>
<h2><a class="anchor" id="autotoc_md177"></a>
Building partial update packages</h2>
<p >You can customize package contents by calling <code>scripts/update.py</code> directly. For example, to build a package only for installing BLE FULL stack:</p>
<div class="fragment"><div class="line">scripts/update.py generate \</div>
<div class="line">  -t f7 -d r13.3_full -v &quot;BLE FULL 13.3&quot; \</div>
<div class="line">  --stage dist/f7/flipper-z-f7-updater-*.bin \</div>
<div class="line">  --radio lib/STM32CubeWB/Projects/STM32WB_Copro_Wireless_Binaries/STM32WB5x/stm32wb5x_BLE_Stack_full_fw.bin \</div>
<div class="line">  --radiotype ble_full</div>
</div><!-- fragment --><p >For the full list of options, check <code>scripts/update.py generate</code> help. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
